<#
############################################################################################################
# Created by pierranchis                            # Description: Migrates mailbox to Office 365, assigns #
# Migrate Mailbox to O365                           # region code, and license.                            #
# Created:                                          #                                                      #
#                                                   #                                                      #
# Revision: 1.2.3 - 11/02/2018                      #                                                      #
############################################################################################################
#>

# Import the AD powershell module
    Import-Module activedirectory

# Declare Variables
    $AzureADServer = 'AzureDCServer'
    $FullDomain = '@abcd.com'
    $LocalDomain = 'abcd\'
    $OnPremURI = 'http://exchangeserver.abcd.com/PowerShell/'
    $OnPremExRemoteHostName = 'mail.abcd.com'
    $O365TenantName = 'O365TenantName.mail.onmicrosoft.com'
    $O365RegionCode = 'Code'
    $O365ProductSku = 'SKU'

# Initializing a Countdown Function
    Function Start-Countdown
      {
        Param(
                [Int32]$Seconds = 30,
                [string]$Message = "Pausing for 30 seconds..."
              )
        ForEach ($Count in (1..$Seconds))
          {
            Write-Progress -Id 1 -Activity $Message -Status "Time Left: $Seconds seconds, $($Seconds - $Count)" -PercentComplete (($Count / $Seconds) * 100)
            Start-Sleep -Seconds 1
          }
        Write-Progress -Id 1 -Activity $Message -Status "Completed" -PercentComplete 100 -Completed
      }

# Initializing Azure DS Force Sync Function
  function Start-DeltaSync
    {
      $session = New-PSSession -ComputerName $AzureADServer
      Invoke-Command -Session $session -ScriptBlock {Start-ADSyncSyncCycle Delta}
      Remove-PSSession $session
    }

# Prompt the user for Login Credentials
  Write-Host "READ ME! Authentication: Enter your privileged user account. Example; jdoe" -ForegroundColor Yellow
    $DomainUser = Read-Host -Prompt "Privileged User Account"
    $UPNLogin = $DomainUser + $FullDomain
    $DomainLogin = $LocalDomain + $DomainUser
  Write-Host "READ ME! Authentication: Enter your privileged user account password." -ForegroundColor Yellow
    $DomainPassword = Read-Host -AsSecureString "Privileged User Account Password"

# Create credential sets
  $UPNCredentials = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $UPNLogin,$DomainPassword
  $DomainCredentials = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $DomainLogin,$DomainPassword

# Connect to Exchange On-Prem
  $ExSession = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri $OnPremURI -Credential $DomainCredentials
  Import-PSSession $ExSession -AllowClobber

# Connect to Exchange O365
  $O365Session = New-PSSession -ConfigurationName Microsoft.Exchange -ConnectionUri https://outlook.office365.com/powershell-liveid/ -Credential $UPNCredentials -Authentication Basic -AllowRedirection
  Import-PSSession $O365Session -AllowClobber

# Prompt for the email address to migrate
  $Username = Read-Host -Prompt "Enter User's username. Example; jdoe"
  $UserToMigrateInput = $Username + $FullDomain

# Forcing Azure Directory Synchronization with Domain Controllers
  Start-DeltaSync
  Write-Host
  Write-Host
  Write-Host "Forcing Azure Directory Synchronization with Domain Controllers. Waiting 3 minutes.`n "
  Write-Host
  Write-Host
  Start-Countdown -Seconds 180 -Message "Forcing Azure Directory Synchronization with Domain Controllers. Waiting 3 minutes"

# Migrate user
  New-MoveRequest -Remote -RemoteHostName $OnPremExRemoteHostName -RemoteCredential $DomainCredentials -TargetDeliveryDomain $O365TenantName -Identity $UserToMigrateInput -BadItemLimit 200

# Connect to Microsoft Online Services
  $MsolSession = Connect-MsolService -Credential $UPNCredentials

# Assign User Regional Setting to USA
  Set-MsolUser -Userprincipalname $UserToMigrateInput -UsageLocation $O365RegionCode

# Assign Enterpack Pack License to user
  Start-Countdown -Seconds 10 -Message "Applying Regional Setting. Waiting 10 seconds."
  Set-MsolUserLicense -User $UserToMigrateInput -AddLicenses $O365ProductSku

# End of Script Notification
  Write-Host "User Migration script has completed." -ForegroundColor Green

# Disconnect Exhange sessions
  Remove-PSSession $ExSession
  Remove-PSSession $O365Session
